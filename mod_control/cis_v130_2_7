{
  "index": "f6d5e6be-e759-486c-a449-3e4f869739c5",
  "description": "Run individual configuration, compliance and security controls or full compliance benchmarks for CIS, Forseti Security and CFT Scorecard across all your GCP projects.",
  "modName": "gcp_compliance",
  "resourceName": "cis_v130_2_7",
  "severity": "low",
  "sql": "WITH filter_data AS (\n  SELECT \n    m.project AS project,\n    display_name AS alert_name,\n    COUNT(m.name) AS metric_name\n  FROM \n    gcp.gcp_monitoring_alert_policy as a,\n    jsonb_array_elements(conditions) AS filter_condition\n  JOIN \n    gcp.gcp_logging_metric m\n  ON \n    m.filter LIKE '%resource.type=\"gce_firewall_rule\"%'\n    AND (\n      m.filter LIKE '%protoPayload.methodName:\"compute.firewalls.patch\"%'\n      OR m.filter LIKE '%protoPayload.methodName:\"compute.firewalls.insert\"%'\n      OR m.filter LIKE '%protoPayload.methodName:\"compute.firewalls.delete\"%'\n    )\n    AND filter_condition -> 'conditionThreshold' ->> 'filter' LIKE '%metric.type = \"' || m.metric_descriptor_type || '\"%'\n  WHERE \n    enabled\n\tand m.project_id=projectId\n\tand m.cd_snapshot_version=snapshotVersion\n\tand a.project_id=projectId\n\tand a.cd_snapshot_version=snapshotVersion\n  GROUP BY \n    m.project, display_name, m.name\n)\nSELECT \n  'https://cloudresourcemanager.googleapis.com/v1/projects/' || project_id AS resource,\n  CASE \n    WHEN d.metric_name > 0 THEN 'ok' \n    ELSE 'alarm' \n  END AS status,\n  CASE \n    WHEN d.metric_name > 0 THEN 'Log metric and alert exist for network firewall rule changes.'\n    ELSE 'Log metric and alert do not exist for network firewall rule changes.'\n  END AS reason,\n  project_id AS project\nFROM \n  gcp.gcp_project AS p\nLEFT JOIN \n  filter_data AS d ON d.project = project\n \twhere p.project_id=projectId\n\tand p.cd_snapshot_version=snapshotVersion;",
  "title": "Ensure that the log metric filter and alerts exist for VPC Network Firewall rule changes",
  "path": null,
  "qualifiedName": null,
  "query": "gcp_compliance.query.logging_metric_alert_firewall_rule_changes",
  "controlLevel": "cis_v400_2_7",
  "createdAt": [
    2023,
    7,
    5,
    12,
    0,
    35,
    757244000
  ],
  "remediationAvailable": false,
  "anonymous": false,
  "type": "Project"
}